name: Website Monitor with Daily Status

on:
  schedule:
    - cron: '*/5 * * * *'   # हर 5 मिनट - website ping
    - cron: '0 9 * * *'     # रोज सुबह 9:00 AM - daily report
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Ping website every 5 minutes
        env:
          URL: https://telegramforwarder-5gl5.onrender.com
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "🔄 Pinging: $URL"
          
          # Ping website with retry
          HTTP_CODE=$(curl -sSL -o /dev/null -w "%{http_code}" --max-time 30 "$URL")
          echo "Status Code: $HTTP_CODE"
          
          # Read previous status
          if [ -f .last_status ]; then
            LAST_STATUS=$(cat .last_status)
          else
            LAST_STATUS="UP"
          fi
          
          # Check status and send alerts if changed
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "UP" > .last_status
            if [ "$LAST_STATUS" = "DOWN" ]; then
              curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
                -d chat_id="$TG_CHAT_ID" \
                -d text="✅ RECOVERY: Website is BACK UP at $(date)"
            fi
          else
            echo "DOWN" > .last_status
            if [ "$LAST_STATUS" = "UP" ]; then
              curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
                -d chat_id="$TG_CHAT_ID" \
                -d text="⚠️ ALERT: Website is DOWN at $(date)"
            fi
          fi

  daily-report:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * *'
    steps:
      - name: Send daily status
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          MESSAGE="🤖 **Daily Bot Status Report**

✅ Your Auto Forwarder Bot is working perfectly!
🕘 Last checked: $(date)
🌐 URL: https://telegramforwarder-5gl5.onrender.com
📊 System: Active and Monitoring

💫 Everything is running smoothly! 🎉"

          curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
          
          echo "✅ Daily status sent to Telegram"
